---
# Ansible Tasks for Cowrie SSH/Telnet Honeypot
##############################################

# Available tags:
# - debug
# - never
# - always
# - update
# - root      -- this tags require sudo access
# - docker    -- for use with docker

# Prepare Operating System
# These tasks need to be executed as root
##############################################

- name: apt-get update
  apt: update_cache=yes
  tags: [update, root, never]
  when: ansible_facts['os_family'] == 'Debian'

# TODO: Use independent method ??
# - name: Install prerequisites packages
#   package:
#     name: git
#     state: present

#  'default-libmysqlclient-dev', -> on debian
#  'libmysqlclient-dev', -> on ubuntu etc

- name: Ensure debian os dependencies
  become: true
  tags: [packages, root]
  apt:
    name: ['git-core', 'libffi-dev', 'libssl-dev',
           'libxml2-dev', 'libxslt1-dev', 'openssl', 'python-pip',
           'python-setuptools', 'python-dev', 'build-essential', 'virtualenv']
    state: present
    install_recommends: false
  when: ansible_facts['distribution'] == 'Debian'

- name: Ensure ubuntu os dependencies
  become: true
  tags: [packages, root]
  apt:
    name: ['git-core', 'libffi-dev', 'libssl-dev', 'python-virtualenv',
           'libxml2-dev', 'libxslt1-dev', 'openssl', 'python-pip',
           'python-setuptools', 'python-dev', 'build-essential']
    state: present
    install_recommends: false
  when: ansible_facts['distribution'] == 'Ubuntu'

# TODO: look into DNF, RedHat's new package manager

- name: Ensure redhat os dependencies
  become: true
  tags: [packages, root]
  yum:
    name: ['git', 'python-virtualenv', '@Development tools', 'libffi',
           'libffi-devel', 'openssl-devel']
    state: present
  when: ansible_facts['os_family'] == 'RedHat'

# TODO: Probably don't need this at the OS level

# - name: PIP Install Packages
#   become: true
#   tags: [packages, update]
#   pip:
#     - name: virtualenv
#     - state: present

- name: Ensure Cowrie user
  become: true
  tags: [user, root]
  user:
    name: "{{ cowrie_user }}"
    home: "{{ cowrie_home }}"
    comment: "Used to run Cowrie SSH/Telnet Honeypot"
    state: present
    password: "!"

- name: Ensure Cowrie group
  become: true
  tags: [user, root]
  group:
    name: "{{ cowrie_group }}"
    state: present
